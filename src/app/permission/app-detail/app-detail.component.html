<ocx-portal-page permission="APP#VIEW" helpArticleId="PAGE_PERMISSION_DETAIL">
  <ocx-page-header
    [loading]="loadingApp"
    [actions]="(actions$ | async) ?? []"
    [header]="loadingApp ? '' : ('DIALOG.DETAIL.HEADER.' + currentApp.appType | translate) + currentApp.name"
    [subheader]="loadingApp ? '' : ('DIALOG.DETAIL.SUBHEADER_' + currentApp.appType | translate)"
    [manualBreadcrumbs]="false"
  >
  </ocx-page-header>

  <ocx-page-content>
    <p-message
      *ngIf="exceptionKey"
      id="apm_app_detail_permission_table_data_access_issue"
      severity="error"
      styleClass="m-3"
      [text]="exceptionKey | translate"
    ></p-message>
    <p-message
      *ngIf="loadingApp || loadingPermissions"
      id="apm_app_detail_permission_table_data_loading"
      severity="info"
      styleClass="m-3"
      [text]="'ACTIONS.LOADING' | translate"
    ></p-message>

    <p-table
      *ngIf="!exceptionKey && !loadingApp && !loadingPermissions"
      #permissionTable
      id="apm_app_detail_permission_table"
      styleClass="pb-2 px-2 sm:px-3"
      [columns]="rolesFiltered"
      [value]="permissionRows"
      [globalFilterFields]="filterBy"
      (onSort)="onSortPermissionTable()"
      [scrollable]="true"
      scrollHeight="590px"
      [rows]="10"
      [rowsPerPageOptions]="[10, 30, 100, 1000]"
      [paginator]="true"
      [alwaysShowPaginator]="true"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="{first} - {last} {{ 'ACTIONS.SEARCH.OF' | translate }} {totalRecords}"
    >
      <ng-template pTemplate="caption">
        <div class="py-1 px-0 flex flex-wrap justify-content-between gap-2">
          <div class="flex align-items-center sm:ml-1 gap-1">
            <div
              class="slim-selectbutton align-items-start search-criteria-selectbutton"
              [pTooltip]="'DIALOG.DETAIL.QUICK_FILTER.TOOLTIP' | translate"
              tooltipPosition="top"
              tooltipEvent="hover"
            >
              <p-selectButton
                inputid="apm_app_detail_permission_table_quick_filter"
                styleClass="text-sm sm:text-base"
                [options]="(quickFilterItems$ | async) ?? []"
                [(ngModel)]="quickFilterValue"
                (onChange)="onQuickFilterChange($event)"
                [allowEmpty]="false"
                [ariaLabel]="'DIALOG.DETAIL.QUICK_FILTER.TOOLTIP' | translate"
              >
                <ng-template let-item pTemplate
                  ><span [id]="'pm_app_detail_quick_filter_' + item.value"> {{ item.label }}</span></ng-template
                >
              </p-selectButton>
              <div class="p-selectbutton-subtitle opacity-80">{{ 'DIALOG.DETAIL.QUICK_FILTER.LABEL' | translate }}</div>
            </div>
          </div>
          <!-- Permission Filter -->
          <div class="p-inputgroup w-18rem sm:w-22rem sm:mx-1">
            <button
              id="apm_app_detail_permission_table_filter_contains"
              class="p-inputgroup-addon text-lg font-bold text-center pseudo-selectbutton data-view-control-border"
              [class.p-highlight]="this.filterMode === 'contains'"
              (click)="onFilterModeChange('=')"
              [ariaLabel]="'ACTIONS.SEARCH.FILTER.MODE_CONTAINS' | translate"
              [pTooltip]="'ACTIONS.SEARCH.FILTER.MODE_CONTAINS' | translate"
              tooltipPosition="top"
              tooltipEvent="hover"
            >
              =
            </button>
            <button
              id="apm_app_detail_permission_table_filter_not_contains"
              class="p-inputgroup-addon text-lg font-bold text-center pseudo-selectbutton data-view-control-border"
              [class.p-highlight]="this.filterMode === 'notContains'"
              (click)="onFilterModeChange('!=')"
              [ariaLabel]="'ACTIONS.SEARCH.FILTER.MODE_NOT_CONTAINS' | translate"
              [pTooltip]="'ACTIONS.SEARCH.FILTER.MODE_NOT_CONTAINS' | translate"
              tooltipPosition="top"
              tooltipEvent="hover"
            >
              !=
            </button>
            <span class="p-float-label">
              <input
                #permissionTableFilterInput
                id="apm_app_detail_permission_table_filter"
                pInputText
                type="text"
                class="w-13rem sm:w-15rem data-view-control-border text-responsive"
                (input)="tableFilter($any($event.target).value)"
                [ariaLabel]="'ACTIONS.SEARCH.FILTER.LABEL' | translate"
                [pTooltip]="
                  ('ACTIONS.SEARCH.FILTER.OF' | translate) +
                  ('PERMISSION.RESOURCE' | translate) +
                  ', ' +
                  ('PERMISSION.ACTION' | translate)
                "
                tooltipPosition="top"
                tooltipEvent="hover"
              />
              <label for="apm_app_detail_permission_table_filter" aria-hidden="true">
                {{ 'DIALOG.DETAIL.FILTER.PERMISSION.LABEL' | translate }}
              </label>
            </span>
            <button
              id="apm_app_detail_permission_table_filter_clear"
              class="p-inputgroup-addon bg-primary pseudo-button pi pi-filter-slash"
              (click)="onClearTableFilter()"
              [ariaLabel]="'ACTIONS.SEARCH.FILTER.CLEAR' | translate"
              [pTooltip]="'ACTIONS.SEARCH.FILTER.CLEAR' | translate"
              tooltipPosition="top"
              tooltipEvent="hover"
            ></button>
          </div>
          <p-button
            id="apm_app_detail_permission_table_reload_button"
            styleClass="h-full"
            icon="pi pi-refresh"
            (onClick)="onReload()"
            [ariaLabel]="'ACTIONS.SEARCH.RELOAD' | translate"
            [pTooltip]="'ACTIONS.SEARCH.RELOAD' | translate"
            tooltipPosition="top"
            tooltipEvent="hover"
          ></p-button>
        </div>
        <div class="relative pt-1 px-0 flex flex-wrap justify-content-around row-gap-1 column-gap-3">
          <!-- summary -->
          <div class="xl:absolute hidden xl:block left-0 my-0 mx-1" style="z-index: 3">
            <ul
              *ngIf="!showPermissionTools"
              class="p-0 m-0 flex flex-column row-gap-0 text-sm"
              [attr.aria-label]="'DIALOG.DETAIL.HEADER.SUMMARY' | translate"
            >
              <li class="list-none" [attr.aria-label]="'DIALOG.DETAIL.HEADER.PERMISSIONS' | translate">
                {{ 'DIALOG.DETAIL.HEADER.PERMISSIONS' | translate }}{{ permissions.length }}
              </li>
              <li
                *ngIf="!currentApp.isProduct"
                class="list-none"
                [attr.aria-label]="'DIALOG.DETAIL.HEADER.PRODUCTS' | translate"
              >
                {{ 'DIALOG.DETAIL.HEADER.PRODUCTS' | translate }}{{ currentApp.workspaceDetails?.products?.length }}
              </li>
              <li class="list-none" [attr.aria-label]="'DIALOG.DETAIL.HEADER.ROLES' | translate">
                {{ 'DIALOG.DETAIL.HEADER.ROLES' | translate }}{{ roles.length }}
              </li>
            </ul>
          </div>
          <!-- permissions -->
          <section
            class="my-2 xl:ml-5 flex flex-row align-items-center column-gap-1"
            role="note"
            [attr.aria-label]="'DIALOG.DETAIL.HEADER.PERMISSIONS.MANAGE' | translate"
          >
            <div
              class="font-bold inline-block"
              [attr.aria-label]="'PERMISSION.LABEL' | translate"
              [pTooltip]="'PERMISSION.TOOLTIP' | translate"
              tooltipPosition="top"
              tooltipEvent="hover"
              aria-hidden="true"
            >
              {{ 'PERMISSION.LABEL' | translate }}
            </div>
            <button
              *ngIf="myPermissions.includes('PERMISSION#MANAGE')"
              pbutton
              type="button"
              id="apm_app_detail_permission_table_header_permission_tools"
              class="p-button p-button-rounded p-button-text p-button-icon-only inline-button"
              (click)="showPermissionTools = !showPermissionTools"
              [ariaLabel]="'ACTIONS.VIEW.PERMISSION.TOOLS' | translate"
              [pTooltip]="'ACTIONS.VIEW.PERMISSION.TOOLS' | translate"
              tooltipPosition="top"
              tooltipEvent="hover"
            >
              <span class="pi pi-cog" aria-hidden="true"></span>
            </button>
            <ng-container *ngIf="showPermissionTools">
              <button
                pbutton
                type="button"
                id="apm_app_detail_permission_table_header_permission_create"
                class="p-button p-button-rounded p-button-text p-button-icon-only inline-button"
                (click)="onCreatePermission()"
                [ariaLabel]="'ACTIONS.CREATE.PERMISSION' | translate"
                [pTooltip]="'ACTIONS.CREATE.PERMISSION' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              >
                <span class="pi pi-plus-circle" aria-hidden="true"></span>
              </button>
              <p-checkbox
                type="text"
                inputId="apm_app_detail_permission_table_header_display_additional_row_data"
                styleClass="ml-2 cursor-auto shadow-none"
                [(ngModel)]="displayAdditionalRowData"
                [binary]="true"
                [label]="'DIALOG.DETAIL.ADDITIONAL_INFO' | translate"
                [ariaLabel]="'DIALOG.DETAIL.ADDITIONAL_INFO' | translate"
                [pTooltip]="'DIALOG.DETAIL.ADDITIONAL_INFO.TOOLTIP' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              ></p-checkbox>
            </ng-container>
          </section>
          <!-- roles -->
          <section
            class="flex flex-row justify-content-evenly"
            [attr.aria-label]="'DIALOG.DETAIL.HEADER.ROLES.MANAGE' | translate"
          >
            <div class="flex flex-row align-items-center column-gap-1">
              <div
                class="font-bold inline-block"
                [attr.aria-label]="'ROLE.LABEL' | translate"
                [pTooltip]="'ROLE.TOOLTIP' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
                aria-hidden="true"
              >
                {{ 'ROLE.LABEL' | translate }}
              </div>
              <div class="flex flex-row column-gap-0">
                <button
                  *ngIf="myPermissions.includes('ROLE#MANAGE')"
                  pbutton
                  type="button"
                  id="apm_app_detail_permission_table_header_permission_tools"
                  class="p-button p-button-rounded p-button-text p-button-icon-only inline-button"
                  (click)="showRoleTools = !showRoleTools"
                  [ariaLabel]="'ACTIONS.VIEW.ROLE.TOOLS' | translate"
                  [pTooltip]="'ACTIONS.VIEW.ROLE.TOOLS' | translate"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                >
                  <span class="pi pi-cog" aria-hidden="true"></span>
                </button>
                <ng-container *ngIf="showRoleTools">
                  <button
                    *ocxIfPermission="'ROLE#CREATE'"
                    pbutton
                    type="button"
                    id="apm_app_detail_permission_table_header_add_role_action"
                    class="p-button p-button-rounded p-button-text p-button-icon-only inline-button"
                    (click)="onCreateRole($event)"
                    [ariaLabel]="'ACTIONS.CREATE.ROLE' | translate"
                    [pTooltip]="'ACTIONS.CREATE.ROLE.TOOLTIP' | translate"
                    tooltipPosition="top"
                    tooltipEvent="hover"
                  >
                    <span class="pi pi-plus-circle" aria-hidden="true"></span>
                  </button>
                  <button
                    *ocxIfPermission="'ROLE#CREATE'"
                    pbutton
                    type="button"
                    id="am_app_detail_permission_table_header_action_add_iam_roles"
                    class="p-button p-button-rounded p-button-text p-button-icon-only inline-button"
                    (click)="onAddIAMRoles($event)"
                    [ariaLabel]="'ACTIONS.CREATE.IAM_ROLES' | translate"
                    [pTooltip]="'ACTIONS.CREATE.IAM_ROLES.TOOLTIP' | translate"
                    tooltipPosition="top"
                    tooltipEvent="hover"
                  >
                    <span class="pi pi-bolt" aria-hidden="true"></span>
                  </button>
                  <button
                    *ngIf="missingWorkspaceRoles"
                    pbutton
                    type="button"
                    id="apm_app_detail_permission_table_header_action_add_workspace_roles"
                    class="p-button p-button-rounded p-button-text p-button-icon-only inline-button"
                    (click)="onCreateWorkspaceRoles($event)"
                    [ariaLabel]="'ACTIONS.CREATE.WORKSPACE_ROLES.TOOLTIP' | translate"
                    [pTooltip]="'ACTIONS.CREATE.WORKSPACE_ROLES.TOOLTIP' | translate"
                    tooltipPosition="top"
                    tooltipEvent="hover"
                  >
                    <span class="text-lg letter-icon" aria-hidden="true">w</span>
                  </button>
                </ng-container>
              </div>
              <div *ngIf="roles.length > 3" class="ml-2 p-inputgroup">
                <span class="p-float-label">
                  <input
                    #roleFilter
                    pInputText
                    type="text"
                    id="apm_app_detail_permission_table_header_role_filter"
                    class="w-15rem data-view-control-border text-responsive"
                    (input)="onRoleFilterChange(roleFilter.value)"
                    [ariaLabel]="'DIALOG.DETAIL.ROLES.FILTER.TOOLTIP' | translate"
                    [pTooltip]="'DIALOG.DETAIL.ROLES.FILTER.TOOLTIP' | translate"
                    tooltipPosition="top"
                    tooltipEvent="hover"
                  />
                  <label for="apm_app_detail_permission_table_header_role_filter" aria-hidden="true">
                    {{ 'DIALOG.DETAIL.ROLES.FILTER' | translate }}</label
                  >
                </span>
                <button
                  id="apm_app_detail_permission_table_header_role_filter_clear"
                  class="p-inputgroup-addon bg-primary pseudo-button pi pi-filter-slash"
                  (click)="roleFilter.value = ''; onRoleFilterChange('')"
                  [attr.aria-label]="'ACTIONS.SEARCH.FILTER.CLEAR' | translate"
                  [pTooltip]="'ACTIONS.SEARCH.FILTER.CLEAR' | translate"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                ></button>
                <button
                  id="apm_app_detail_permission_table_header_role_filter_clear"
                  class="p-inputgroup-addon pseudo-button pi pi-times-circle"
                  [ngClass]="{ 'bg-primary': hideEmptyRoles }"
                  (click)="hideEmptyRoles = !hideEmptyRoles"
                  [attr.aria-label]="'ACTIONS.SEARCH.FILTER.CLEAR' | translate"
                  [pTooltip]="'DIALOG.DETAIL.ROLES.HIDE_EMPTY_ROLES.TOOLTIP' | translate"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                ></button>
              </div>
              <p-checkbox
                type="text"
                inputId="apm_app_detail_permission_table_header_hide_empty_roles"
                styleClass="ml-2 cursor-auto shadow-none hidden"
                labelStyleClass="white-space-nowrap hidden"
                [(ngModel)]="hideEmptyRoles"
                [binary]="true"
                [label]="'DIALOG.DETAIL.ROLES.HIDE_EMPTY_ROLES' | translate"
                [ariaLabel]="'DIALOG.DETAIL.ROLES.HIDE_EMPTY_ROLES' | translate"
                [pTooltip]="'DIALOG.DETAIL.ROLES.HIDE_EMPTY_ROLES.TOOLTIP' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              ></p-checkbox>
            </div>
          </section>
        </div>
      </ng-template>

      <ng-template pTemplate="header" let-columns>
        <!-- HEADER ROW - permission filter and role management-->
        <tr>
          <ng-container *ngIf="showPermissionTools">
            <th
              pFrozenColumn
              id="apm_app_detail_permission_table_header_actions"
              class="py-2 vertical-align-bottom border-bottom-2 text-center"
            >
              {{ 'PERMISSION.ACTIONS' | translate }}
            </th>
            <th pFrozenColumn class="py-2 hidden xl:table-cell vertical-align-bottom border-bottom-2">
              <span
                class="pi pi-exclamation-circle"
                [attr.aria-label]="'PERMISSION.MANDATORY.COLUMN' | translate"
                [pTooltip]="'PERMISSION.MANDATORY.COLUMN' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              ></span>
            </th>
          </ng-container>
          <th
            pFrozenColumn
            pSortableColumn="key"
            id="apm_app_detail_permission_table_header_permission_key"
            class="sm:p-2 vertical-align-bottom border-bottom-2"
          >
            <div
              class="pb-2 sm:pb-0 flex flex-column align-items-start sm:flex-row sm:align-items-center row-gap-2 xs:w-6rem"
            >
              <span class="text-sm sm:text-base sm:white-space-nowrap">{{ 'PERMISSION.KEY' | translate }}</span>
              <p-sortIcon field="key"></p-sortIcon>
            </div>
          </th>
          <th
            pFrozenColumn
            *ngIf="currentApp.appType === 'WORKSPACE'"
            id="apm_app_detail_permission_table_header_permission_filter_product"
            class="sm:p-2 hidden xl:table-cell vertical-align-bottom border-bottom-2 sm:white-space-nowrap"
          >
            <div *ngIf="currentApp.isProduct">{{ 'DIALOG.DETAIL.FILTER.PRODUCT' | translate }}</div>
            <div *ngIf="!currentApp.isProduct" class="flex flex-wrap sm:flex-nowrap align-items-center">
              <span #filterProduct class="p-float-label inline-block">
                <p-dropdown
                  id="apm_app_detail_permission_table_filter_product_name"
                  styleClass="w-full clear-icon-used"
                  [appendTo]="'body'"
                  [showClear]="true"
                  [options]="filterProductItems"
                  [(ngModel)]="filterProductValue"
                  (onChange)="onFilterItemChangeProduct($event)"
                  [emptyMessage]="'ACTIONS.SEARCH.NO_DATA' | translate"
                  [ariaLabel]="'DIALOG.DETAIL.FILTER.PRODUCT.TOOLTIP' | translate"
                  [pTooltip]="'DIALOG.DETAIL.FILTER.PRODUCT.TOOLTIP' | translate"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                ></p-dropdown>
                <label for="apm_app_detail_permission_table_filter_product_name" aria-hidden="true">
                  {{ 'DIALOG.DETAIL.FILTER.PRODUCT' | translate }}</label
                >
              </span>
              <button
                pbutton
                type="button"
                id="app_detail_permission_table_sort_product_name"
                class="p-button-rounded p-button-text p-button p-button-icon-only"
                (click)="onFilterItemSortIcon($event, sortIconProduct, 'product')"
                [ariaLabel]="'PERMISSION.SORT.PRODUCT' | translate"
                [pTooltip]="'PERMISSION.SORT.PRODUCT' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              >
                <span #sortIconProduct class="pi pi-sort-alt" aria-hidden="true"></span>
              </button>
            </div>
          </th>
          <th
            pFrozenColumn
            id="apm_app_detail_permission_table_header_permission_filter_app_id"
            class="sm:p-2 vertical-align-bottom border-bottom-2 border-right-2"
          >
            <div class="flex flex-wrap sm:white-space-nowrap align-items-center">
              <span #filterApp class="flex-grow-1 p-float-label inline-block">
                <p-dropdown
                  id="apm_app_detail_permission_table_filter_app_id"
                  styleClass="w-10rem md:w-full clear-icon-used"
                  [appendTo]="'body'"
                  [showClear]="true"
                  [options]="filterAppItems"
                  [(ngModel)]="filterAppValue"
                  (onChange)="permissionTable.filter($event.value, 'appId', 'equals')"
                  (onClear)="onFilterItemClearAppId()"
                  [emptyMessage]="'ACTIONS.SEARCH.NO_DATA' | translate"
                  [pTooltip]="'DIALOG.DETAIL.FILTER.APPS.TOOLTIP' | translate"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                ></p-dropdown>
                <label
                  for="apm_app_detail_permission_table_filter_app_id"
                  class="text-sm sm:text-base"
                  aria-hidden="true"
                >
                  {{ 'DIALOG.DETAIL.FILTER.APPS' | translate }}</label
                >
              </span>
              <button
                pbutton
                type="button"
                id="app_detail_permission_table_sort_app_id"
                class="p-button-rounded p-button-text p-button p-button-icon-only"
                (click)="onFilterItemSortIcon($event, sortIconAppId, 'appId')"
                [ariaLabel]="'PERMISSION.SORT.APP_ID' | translate"
                [pTooltip]="'PERMISSION.SORT.APP_ID' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              >
                <span #sortIconAppId class="pi pi-sort-alt"></span>
              </button>
            </div>
          </th>

          <!-- HEADER ROW - ROLES -->
          <th
            *ngFor="let role of columns"
            id="apm_app_detail_permission_table_header_roles"
            class="p-1 max-w-8rem text-center border-bottom-2 border-right-1 vertical-align-top"
            [ngClass]="{ hidden: hideEmptyRoles && !role.hasAssignments }"
          >
            <div
              *ngIf="myPermissions.includes('PERMISSION#MANAGE')"
              class="flex flex-row gap-0 justify-content-center align-items-center white-space-nowrap"
            >
              <button
                pbutton
                type="button"
                *ngIf="myPermissions.includes('PERMISSION#GRANT') && permissionTable.totalRecords > 0"
                [id]="'app_detail_permission_table_col_' + role.id + '_action_grant_all'"
                class="p-1 p-button-rounded p-button-text p-button p-button-icon-only"
                (click)="onGrantAllPermissions($event, role)"
                [ariaLabel]="'PERMISSION.ASSIGNMENTS.GRANT_ALL_FOR_ROLE' | translate"
                [pTooltip]="'PERMISSION.ASSIGNMENTS.GRANT_ALL_FOR_ROLE' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              >
                <span class="pi pi-circle-fill" aria-hidden="true"></span>
              </button>
              @if (role.hasAssignments) {
                <button
                  pbutton
                  type="button"
                  *ngIf="myPermissions.includes('PERMISSION#GRANT') && permissionTable.totalRecords > 0"
                  [id]="'app_detail_permission_table_col_' + role.id + '_action_revoke_all'"
                  class="p-1 p-button-rounded p-button-text p-button p-button-icon-only"
                  (click)="onRevokeAllPermissions($event, role)"
                  [ariaLabel]="'PERMISSION.ASSIGNMENTS.REVOKE_ALL_FOR_ROLE' | translate"
                  [pTooltip]="'PERMISSION.ASSIGNMENTS.REVOKE_ALL_FOR_ROLE' | translate"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                >
                  <span class="pi pi-circle" aria-hidden="true"></span>
                </button>
              } @else {
                <span
                  class="pi pi-times-circle"
                  aria-hidden="true"
                  [pTooltip]="'DIALOG.DETAIL.ROLES.EMPTY_ROLE' | translate"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                ></span>
              }
              <ng-container *ngIf="showRoleTools">
                <div
                  *ngIf="role.mandatory"
                  class="p-2 danger-action-text pi pi-lock"
                  [attr.aria-label]="'ROLE.MANDATORY' | translate"
                  [pTooltip]="'ROLE.MANDATORY' | translate"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                  role="note"
                ></div>
                <button
                  pbutton
                  type="button"
                  *ngIf="!role.mandatory && myPermissions.includes('ROLE#EDIT')"
                  [id]="'app_detail_permission_table_col_' + role.id + '_action_edit'"
                  class="p-1 p-button-rounded p-button-text p-button p-button-icon-only"
                  (click)="onEditRole($event, role)"
                  [ariaLabel]="'ACTIONS.EDIT.ROLE' | translate"
                  [pTooltip]="'ACTIONS.EDIT.ROLE' | translate"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                >
                  <span class="pi pi-pencil" aria-hidden="true"></span>
                </button>
                <button
                  pbutton
                  type="button"
                  *ngIf="!role.mandatory && myPermissions.includes('ROLE#DELETE')"
                  [id]="'app_detail_permission_table_col_' + role.name + '_action_delete'"
                  class="p-1 mr-0 p-button-rounded p-button-text p-button p-button-icon-only"
                  (click)="onDeleteRole($event, role)"
                  [ariaLabel]="'ACTIONS.DELETE.ROLE' | translate"
                  [pTooltip]="'ACTIONS.DELETE.ROLE' | translate"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                >
                  <span class="pi pi-trash danger-action-text" aria-hidden="true"></span>
                </button>
              </ng-container>
            </div>
            <div
              class="word-break-all text-sm sm:text-base flex flex-row justify-content-center"
              [pTooltip]="role.description ? role.description : ''"
              tooltipPosition="top"
              tooltipEvent="hover"
            >
              <div class="max-w-8rem">{{ role.name + (role.isWorkspaceRole ? ' (w)' : '') }}</div>
            </div>
          </th>
        </tr>
      </ng-template>

      <!-- TABLE BODY -->
      <ng-template pTemplate="body" let-row="rowIndex" let-rowData let-columns="columns">
        <tr [id]="'app_detail_permission_table_row_' + row">
          <ng-container *ngIf="showPermissionTools">
            <td
              pFrozenColumn
              [id]="'app_detail_permission_table_row_' + row + '_actions'"
              class="white-space-nowrap text-center"
            >
              <button
                pbutton
                type="button"
                *ngIf="myPermissions.includes('PERMISSION#EDIT')"
                [id]="'app_detail_permission_table_row_' + row + '_action_edit'"
                class="p-button-rounded p-button-text p-button p-button-icon-only"
                (click)="onDetailPermission($event, rowData)"
                [ariaLabel]="(rowData.mandatory ? 'ACTIONS.VIEW' : 'ACTIONS.EDIT') + '.PERMISSION' | translate"
                [pTooltip]="(rowData.mandatory ? 'ACTIONS.VIEW' : 'ACTIONS.EDIT') + '.PERMISSION' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              >
                <span
                  class="p-button-icon pi"
                  [class.pi-eye]="rowData.mandatory"
                  [class.pi-pencil]="!rowData.mandatory"
                  aria-hidden="true"
                ></span>
              </button>
              <button
                *ngIf="myPermissions.includes('PERMISSION#EDIT')"
                pbutton
                type="button"
                [id]="'app_detail_permission_table_row_' + row + '_action_copy'"
                class="p-button-rounded p-button-text p-button p-button-icon-only"
                (click)="onCopyPermission($event, rowData)"
                [ariaLabel]="'ACTIONS.COPY.PERMISSION' | translate"
                [pTooltip]="'ACTIONS.COPY.PERMISSION' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              >
                <span class="p-button-icon pi pi-copy" aria-hidden="true"></span>
              </button>
              <button
                *ngIf="myPermissions.includes('PERMISSION#DELETE')"
                pbutton
                type="button"
                [id]="'app_detail_permission_table_row_' + row + '_action_delete'"
                class="p-button-rounded p-button-text p-button p-button-icon-only"
                (click)="onDeletePermission($event, rowData)"
                [disabled]="rowData.mandatory"
                [ariaLabel]="'ACTIONS.DELETE.PERMISSION' | translate"
                [pTooltip]="'ACTIONS.DELETE.PERMISSION' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              >
                <span class="danger-action-text p-button-icon pi pi-trash" aria-hidden="true"></span>
              </button>
            </td>
            <td pFrozenColumn class="hidden xl:table-cell">
              <span
                *ngIf="rowData.mandatory"
                class="pi pi-lock"
                [attr.aria-label]="'PERMISSION.MANDATORY.COLUMN' | translate"
                [pTooltip]="'PERMISSION.MANDATORY.COLUMN.TOOLTIP' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              ></span>
            </td>
          </ng-container>
          <td pFrozenColumn [id]="'app_detail_permission_table_row_' + row + '_permission_key'">
            <div
              class="word-break-all text-sm sm:text-base text-ellipsis-3-lines max-w-9rem sm:max-w-full sm:min-w-13rem"
            >
              {{ rowData.resource }} # {{ rowData.action }}
            </div>
            <div *ngIf="displayAdditionalRowData" class="mt-1 text-xs hidden lg:block">{{ rowData.description }}</div>
          </td>
          <td
            *ngIf="currentApp.appType === 'WORKSPACE'"
            pFrozenColumn
            [id]="'app_detail_permission_table_row_' + row + '_product_name'"
            class="hidden xl:table-cell"
          >
            <div
              class="word-break-all text-sm sm:text-base text-ellipsis-3-lines max-w-9rem sm:max-w-full sm:min-w-13rem"
            >
              {{ rowData.productDisplayName }}
            </div>
          </td>
          <td pFrozenColumn id="apm_app_detail_permission_table_data_app_id" class="border-right-2">
            <div
              class="word-break-all text-sm sm:text-base text-ellipsis-3-lines max-w-9rem sm:max-w-full sm:min-w-13rem"
            >
              {{ rowData.appDisplayName }}
            </div>
          </td>

          <!-- ASSIGNMENTS -->
          <td
            *ngFor="let role of columns"
            [id]="'apm_app_detail_permission_table_' + row + '_' + role.name + '_' + rowData.key"
            class="text-center border-right-1"
            [ngClass]="{ hidden: hideEmptyRoles && !role.hasAssignments }"
          >
            <!-- mandatory = display only -->
            <div *ngIf="protectedAssignments.includes(rowData.roles[role.id])">
              <span
                *ngIf="rowData.roles[role.id]"
                [id]="'apm_app_detail_permission_table_' + row + '_' + role.name + '_' + rowData.key + '_lock'"
                class="text-primary pi pi-lock"
                [attr.aria-label]="'PERMISSION.ASSIGNMENTS.ROLE_IS_ASSIGNED_1.MANDATORY' | translate"
                [pTooltip]="'PERMISSION.ASSIGNMENTS.ROLE_IS_ASSIGNED_1.MANDATORY' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              >
              </span>
            </div>
            <!-- not mandatory = display depending on permissions -->
            <ng-container *ngIf="!protectedAssignments.includes(rowData.roles[role.id])">
              <div *ngIf="!myPermissions.includes('PERMISSION#GRANT')">
                <span
                  *ngIf="rowData.roles[role.id]"
                  class="text-primary text-lg pi pi-circle-fill"
                  [id]="'apm_app_detail_permission_table_' + row + '_' + role.name + '_' + rowData.key + '_assigned'"
                  [attr.aria-label]="'PERMISSION.ASSIGNMENTS.ROLE_IS_ASSIGNED_1' | translate"
                  [pTooltip]="'PERMISSION.ASSIGNMENTS.ROLE_IS_ASSIGNED_1' | translate"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                >
                </span>
                <span
                  *ngIf="!rowData.roles[role.id]"
                  class="text-primary text-lg pi pi-circle"
                  [id]="
                    'apm_app_detail_permission_table_' + row + '_' + role.name + '_' + rowData.key + '_not_assigned'
                  "
                  [attr.aria-label]="'PERMISSION.ASSIGNMENTS.ROLE_IS_ASSIGNED_0' | translate"
                  [pTooltip]="'PERMISSION.ASSIGNMENTS.ROLE_IS_ASSIGNED_0' | translate"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                >
                </span>
              </div>
              <div *ngIf="myPermissions.includes('PERMISSION#GRANT')">
                <!-- not assigned -->
                <button
                  *ngIf="!rowData.roles[role.id]"
                  pbutton
                  type="button"
                  class="my-0 p-1 p-button-rounded p-button-text p-button p-button-icon-only"
                  (click)="onAssignPermission(rowData, role)"
                  [id]="
                    'apm_app_detail_permission_table_' + row + '_' + role.name + '_' + rowData.key + '_not_assigned'
                  "
                  [ariaLabel]="('PERMISSION.ASSIGNMENTS.GRANT_ROLE' | translate) + role.name + ' + ' + rowData.key"
                  [pTooltip]="('PERMISSION.ASSIGNMENTS.GRANT_ROLE' | translate) + role.name + ' + ' + rowData.key"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                >
                  <span class="text-primary text-lg p-button-icon pi pi-circle" aria-hidden="true"></span>
                </button>

                <!-- assigned -->
                <button
                  *ngIf="rowData.roles[role.id]"
                  pbutton
                  type="button"
                  class="my-0 p-1 p-button-rounded p-button-text p-button p-button-icon-only"
                  (click)="onRemovePermission(rowData, role)"
                  [id]="'apm_app_detail_permission_table_' + row + '_' + role.name + '_' + rowData.key + '_assigned'"
                  [ariaLabel]="('PERMISSION.ASSIGNMENTS.REVOKE_ROLE' | translate) + role.name + ' + ' + rowData.key"
                  [pTooltip]="('PERMISSION.ASSIGNMENTS.REVOKE_ROLE' | translate) + role.name + ' + ' + rowData.key"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                >
                  <span class="text-primary text-lg p-button-icon pi pi-circle-fill" aria-hidden="true"></span>
                </button>
              </div>
            </ng-container>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </ocx-page-content>
</ocx-portal-page>

<app-role-detail
  [currentApp]="currentApp"
  [roles]="roles"
  [role]="role"
  [changeMode]="changeMode"
  [showIamRolesDialog]="showIamRolesDialog"
  [displayDetailDialog]="showRoleDetailDialog"
  [displayDeleteDialog]="showRoleDeleteDialog"
  (dataChanged)="onDetailChanged($event)"
></app-role-detail>

<app-permission-detail
  [currentApp]="currentApp"
  [permissions]="permissions"
  [permission]="permission"
  [changeMode]="changeMode"
  [displayDetailDialog]="displayPermissionDetailDialog"
  [displayDeleteDialog]="displayPermissionDeleteDialog"
  (dataChanged)="onDetailChanged($event)"
></app-permission-detail>

<app-permission-export
  [products]="productNames"
  [listedProductsHeaderKey]="listedProductsHeaderKey"
  [(displayExportDialog)]="displayPermissionExportDialog"
></app-permission-export>
