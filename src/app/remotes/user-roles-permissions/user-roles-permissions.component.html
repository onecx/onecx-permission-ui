<p-tabView *ngIf="(userAssignments$ | async)?.sort(sortUserAssignments) as items">
  <p-tabPanel>
    <ng-template pTemplate="header">
      <span
        [pTooltip]="'USER_ROLE_PERMISSIONS.TABS.PERMISSIONS.TOOLTIP' | translate"
        tooltipPosition="top"
        tooltipEvent="hover"
      >
        {{ 'USER_ROLE_PERMISSIONS.TABS.PERMISSIONS' | translate }}
      </span>
    </ng-template>
    <p-message
      *ngIf="searchInProgress"
      severity="info"
      styleClass="m-3"
      [text]="'ACTIONS.LOADING' | translate"
    ></p-message>
    <p-table
      *ngIf="!searchInProgress"
      #permissionTable
      [columns]="columns"
      [value]="items"
      styleClass="p-datatable-striped user-roles-and-permissions"
      [autoLayout]="true"
      [globalFilterFields]="['productName', 'role', 'resource', 'action']"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 100, 1000]"
      [alwaysShowPaginator]="true"
      paginatorPosition="bottom"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="{first} - {last} {{ 'ACTIONS.SEARCH.OF' | translate }} {totalRecords}"
    >
      <ng-template pTemplate="caption">
        <div class="flex flex-wrap justify-content-between align-items-center gap-2">
          <div class="font-bold">
            {{ 'USER_ROLE_PERMISSIONS.TABS.PERMISSIONS.TITLE' | translate }} {{ items.length }}
          </div>
          <div class="p-inputgroup w-auto">
            <span class="p-inputgroup-addon data-view-control-border">
              <span class="pi pi-filter"></span>
            </span>
            <span class="p-float-label">
              <input
                #permissionTableFilterInput
                pInputText
                type="text"
                id="up_permission_table_filter"
                (input)="applyGlobalFilter($event, permissionTable)"
                [ariaLabel]="'ACTIONS.SEARCH.FILTER.LABEL' | translate"
                [pTooltip]="
                  ('ACTIONS.SEARCH.FILTER.OF' | translate) +
                  ('USER_ROLE_PERMISSIONS.ROLE' | translate) +
                  ', ' +
                  ('USER_ROLE_PERMISSIONS.PRODUCT' | translate) +
                  ', ' +
                  ('USER_ROLE_PERMISSIONS.RESOURCE' | translate) +
                  ', ' +
                  ('USER_ROLE_PERMISSIONS.ACTION' | translate)
                "
                tooltipPosition="top"
                tooltipEvent="hover"
              />
              <label for="up_permission_table_filter">{{ 'ACTIONS.SEARCH.FILTER.LABEL' | translate }}</label>
            </span>
            <a
              id="up_permission_table_filter_clear"
              class="p-inputgroup-addon bg-primary cursor-pointer pi pi-filter-slash"
              (click)="onClearFilterUserAssignmentTable()"
              tabindex="0"
              [pTooltip]="'ACTIONS.SEARCH.FILTER.CLEAR' | translate"
              tooltipPosition="top"
              tooltipEvent="hover"
            >
            </a>
          </div>
          <div class="ml-3 flex column-gap-2">
            <p-button
              type="button"
              id="up_permissions_header_action_reload"
              styleClass="h-full"
              icon="pi pi-refresh"
              (onClick)="onReload()"
              [pTooltip]="'ACTIONS.SEARCH.RELOAD' | translate"
              tooltipPosition="top"
              tooltipEvent="hover"
            >
            </p-button>
          </div>
        </div>
      </ng-template>

      <ng-template pTemplate="header" let-columns>
        <tr>
          <th id="up_permissions_table_header_permission" colspan="3" class="text-center border-permission-group p-1">
            {{ 'USER_ROLE_PERMISSIONS.PERMISSION' | translate }}
          </th>
          <th id="up_permissions_table_header_role" class="border-none"></th>
        </tr>
        <tr>
          <th
            *ngFor="let col of columns"
            [id]="'up_permissions_table_header_' + col.field"
            [pSortableColumn]="col.field"
            class="p-2 text-center white-space-nowrap"
            [pTooltip]="col.tooltip | translate"
            tooltipPosition="top"
            tooltipEvent="hover"
          >
            <ng-container *ngIf="!col.filter"> {{ col.header | translate }} </ng-container>
            <p-dropdown
              *ngIf="col.filter"
              [options]="extractFilterItems(items, col.field)"
              (onClick)="$event.stopPropagation()"
              (onChange)="permissionTable.filter($event.value, col.field, 'equals')"
              [placeholder]="col.header | translate"
              [showClear]="true"
              panelStyleClass="text-left"
            >
              <ng-template let-option pTemplate="item"> {{ option }} </ng-template>
            </p-dropdown>
            <p-sortIcon [field]="col.field"></p-sortIcon>
          </th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-item let-columns="columns" let-i="rowIndex">
        <tr>
          <td *ngFor="let col of columns" [id]="'up_permissions_table_row_' + i + '_' + col.field">
            {{ item[col.field] }}
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td [attr.colspan]="columns.length" id="up_permissions_table_no_results">
            {{ 'USER_ROLE_PERMISSIONS.NO_RESULTS' | translate }}
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-tabPanel>

  <!-- ROLES & MORE -->
  <p-tabPanel>
    <ng-template pTemplate="header">
      <span
        [pTooltip]="'USER_ROLE_PERMISSIONS.TABS.ROLES_N_MORE.TOOLTIP' | translate"
        tooltipPosition="top"
        tooltipEvent="hover"
      >
        {{ 'USER_ROLE_PERMISSIONS.TABS.ROLES_N_MORE' | translate }}
      </span>
    </ng-template>

    <div class="m-3 flex flex-row flex-wrap justify-content-start align-items-start column-gap-5">
      <!-- ROLES -->
      <ng-container *ngIf="extractFilterItems(items, 'roleName') as roles">
        <div *ngIf="roles.length === 1">
          <div id="up_user_roles_one" class="font-bold">
            {{ 'USER_ROLE_PERMISSIONS.TABS.ROLE.TITLE' | translate }} {{ roles[0] }}
          </div>
        </div>
        <div *ngIf="roles.length > 1" class="flex flex-column row-gap-2">
          <div
            class="font-bold"
            [pTooltip]="'USER_ROLE_PERMISSIONS.TABS.ROLES.TOOLTIP' | translate"
            tooltipPosition="top"
            tooltipEvent="hover"
          >
            {{ 'USER_ROLE_PERMISSIONS.TABS.ROLES.TITLE' | translate }} {{ roles.length }}
          </div>
          <p-listbox
            id="up_user_roles_list"
            [options]="roles"
            [filter]="true"
            [filterPlaceHolder]="'USER_ROLE_PERMISSIONS.TABS.ROLES.FILTER' | translate"
            [listStyle]="{ 'max-height': '300px' }"
          />
        </div>
      </ng-container>

      <!-- PRODUCTS -->
      <ng-container *ngIf="extractFilterItems(items, 'productName') as products">
        <div *ngIf="products.length === 1">
          <div id="up_user_products_one" class="font-bold">
            {{ 'USER_ROLE_PERMISSIONS.TABS.ROLE.TITLE' | translate }} {{ products[0] }}
          </div>
        </div>
        <div *ngIf="products.length > 1" class="flex flex-column row-gap-2">
          <div
            class="font-bold"
            [pTooltip]="'USER_ROLE_PERMISSIONS.TABS.PRODUCTS.TOOLTIP' | translate"
            tooltipPosition="top"
            tooltipEvent="hover"
          >
            {{ 'USER_ROLE_PERMISSIONS.TABS.PRODUCTS.TITLE' | translate }} {{ products.length }}
          </div>
          <p-listbox
            id="up_user_products_list"
            [options]="products"
            [filter]="true"
            [filterPlaceHolder]="'USER_ROLE_PERMISSIONS.TABS.PRODUCTS.FILTER' | translate"
            [listStyle]="{ 'max-height': '300px' }"
          />
        </div>
      </ng-container>
    </div>
  </p-tabPanel>
</p-tabView>
